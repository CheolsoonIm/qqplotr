---
title: "An Introduction to qqplotr"
author: "Alexandre Almeida"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{An Introduction to qqplotr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette presents a more in-depth walkthrough of the `qqplotr` package
functionalities.

The `qqplotr` package itself extends some `ggplot2` functionalities by 
permitting the drawing of quantile-quantile (Q-Q) and probability-probability 
(P-P) points, lines, and confidence bands. The functions of this package also 
allow the detrend adjustment, which was proposed by Thode (2002) to help reduce 
visual bias when assessing those type of plots.

## Installation

If you would like to install the development version of `qqplotr`, you may do so
by using, for example, `devtools`:

``` {r eval = F} 
# install.packages("devtools")
library(devtools)
install_github("aloy/qqplotr")
```

If instead you wish to install the stable CRAN version, then simply do:

``` {r eval = F} 
install.packages("qqplotr")
```

## Details

The functions of this package, implemeneted as `ggplot2` Stats, are divided
into two groups: (1) Q-Q and (2) P-P plot.

Both groups are composed of three functions: *point*, *line*, and *band*. Those 
Stats complement each other when plotted together, but they may also be plotted
independently.

Below we give a quick overview of each of all the implemented Stats.

### Q-Q plot

* `stat_qq_point` This is a modified version of `ggplot2::stat_qq` 
with some parameters adjustments and a new option to detrend the points.
* `stat_qq_line` Draws a reference line based on the first and third quartiles
of the data (as in `stats::qqline`).
* `stat_qq_band` Draws confidence bands based on three methods: `"normal"`, 
`"bs"`, and `"ts"`.
	+ `"normal"` constructs simultaneous confidence bands based on Normal confidence
intervals;
	+ `"bs"` creates pointwise confidence bands based on a parametric boostrap;
	+ `"ts"` constructs tail-sensitive confidence bands (Aldor-Noiman et al., 2013).
	
Also, in order to visualize multiple Q-Q band methods at the same time, we 
produced the `geom_qq_band` Geom, which usage will be better illustrated below.

### P-P plot

* `stat_pp_point` Plots cumulative probabilities versus probability points. The
cumulative probability function is constructed with the sample data, and the
evaluated at each probability point. Hence, the plotted points will be limited
in a unit square plot, since only probabilities are being plotted.
* `stat_pp_line` Draws a reference identity line ($x = y$).
* `stat_pp_band` Draws confidence bands. For now, only the bootstrap version
(`"bs"`) is available.

## Usage

Start by loading the `qqplotr` package:

```{r message = F}
require(qqplotr)
```

First, let simulate a Normal-distributed sample:

```{r}
set.seed(0)
smp <- data.frame(norm = rnorm(100))
```

Then, we use the provided `stat_qq_*` functions to construct a complete Q-Q plot
with the points, reference line, and the confidence bands. As default, the 
standard Q-Q Normal plot with Normal confidence bands is constructed:

```{r fig.align = "center", fig.width = 7, fig.height = 5} 
gg <- ggplot(data = smp, mapping = aes(sample = norm)) +
	stat_qq_band() +
	stat_qq_line() +
	stat_qq_point() +
	labs(x = "Theoretical Quantiles", y = "Sample Quantiles")
gg
```

As we can see, all the points lie within the confidence bands, which is
expected.

As previously described in the Details section, three confidence bands 
constructs are available, which may be adjusted with the `bandType` parameter. 
Here, we may use the `geom_qq_band` instead of `stat_qq_band` to have a little 
more flexibility with graphical parameters when constructing and visualizing
different confidence bands.

```{r fig.align = "center", fig.width = 7, fig.height = 5} 
gg <- ggplot(data = smp, mapping = aes(sample = norm)) +
	geom_qq_band(bandType = "ts", aes(fill = "TS")) +
	geom_qq_band(bandType = "normal", aes(fill = "Normal")) +
	geom_qq_band(bandType = "bs", aes(fill = "Bootstrap")) +
	stat_qq_line() +
	stat_qq_point() +
	labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
	scale_fill_discrete("Bandtype")
gg
```

To construct Q-Q plots with other theoretical distributions we may use the 
`distribution` parameter. Specific distributional parameters may be passed as a 
list to the `dparams` paramater. Note that distributional parameters have little
impact when building Q-Q plots, as they usually only change the x-axis range. 
Those paramaters will affect more the P-P plots, which is shown further in this
text.

Now, say that we want to create a Q-Q plot with a different sample data - the 
*mean ozone levels* from the `airquality` dataset. Since the data is 
non-negative, lets evaluate the Exponential distribution (`exp`) as the
theoretical.

> It is important to note that the distribution nomenclature follows that from 
the `stats` package. So, if you wish to provide a custom distribution, you may 
do so by creating the density, cumulative, quantile, and random functions 
following the standard nomenclature from the \code{stats} package, i.e., for 
\code{"custom"}, create the \code{"dcustom"}, \code{"pcustom"}, 
\code{"qcustom"}, and \code{"rcustom"} functions.

That being said, let's set `distribution = "exp"` and `rate = 2` (the latter one
just to exemplify the usage):

```{r fig.align = "center", fig.width = 7, fig.height = 5} 
di <- "exp" # exponential distribution
dp <- list(rate = 2) # exponential rate parameter

gg <- ggplot(data = airquality, mapping = aes(sample = Ozone)) +
	stat_qq_band(distribution = di, dparams = dp) +
	stat_qq_line(distribution = di, dparams = dp) +
	stat_qq_point(distribution = di, dparams = dp) +
	labs(x = "Theoretical Quantiles", y = "Sample Quantiles")
gg
```

With this package we may also *detrend* the Q-Q and P-P plots to help reducing
visual bias caused by the orthogonal distances from points to the reference
lines. That bias may cause wrong conclusions to be made via visual inference of
the plot. We do that by setting `detrend = TRUE`:

```{r fig.align = "center", fig.width = 7, fig.height = 5}
de <- TRUE # enabling the detrend option

gg <- ggplot(data = airquality, mapping = aes(sample = Ozone)) +
	stat_qq_band(distribution = di, dparams = dp, detrend = de) +
	stat_qq_line(distribution = di, dparams = dp, detrend = de) +
	stat_qq_point(distribution = di, dparams = dp, detrend = de) +
	labs(x = "Theoretical Quantiles", y = "Sample Quantiles")
gg
```

Note that the detrend option causes to plot to "rotate". Now, instead of being
presented as a diagonal plot, we visualize the data in a horizontal manner.

***

Now let's evaluate how's the behavior of the P-P plots. We start by plotting
the simulated Normal data versus the standard Normal distribution:

```{r fig.align = "center", fig.width = 7, fig.height = 5} 
gg <- ggplot(data = smp, mapping = aes(sample = norm)) +
	stat_pp_band() +
	stat_pp_line() +
	stat_pp_point() +
	labs(x = "Probability Points", y = "Cumulative Probability")
gg
```

The cumulative probability points (y-axis) are constructed by evaluating the
theoretical CDF on sample quantiles. As we can see, with the exception of one
point at the lower tail, all the other points lie within the confidence bands.

As discussed before, different from the Q-Q plot, here the distributional 
parameters **do** impact the results. Say we want to evaluate the same standard 
Normal data with a shifted and rescaled Normal(2,2) distribution:

```{r fig.align = "center", fig.width = 7, fig.height = 5}
dp <- list(mean = 2, sd = 2) # shifted and rescaled normal parameters

gg <- ggplot(data = smp, mapping = aes(sample = norm)) +
	stat_pp_band(dparams = dp) +
	stat_pp_line() +
	stat_pp_point(dparams = dp) +
	labs(x = "Probability Points", y = "Cumulative Probability")
gg
```

As we already know, the plot shows that the parameters chosen by the theoretical
distribution are not appropriate.

We may also detrend the P-P plots in the same way as before. Let's evaluate 
again the *mean ozone levels* from the `airquality` dataset. We had previously 
seen that the Exponential distribution was more appropriate than the Normal
distribution, so let's also take that into account:

```{r fig.align = "center", fig.width = 7, fig.height = 5}
di <- "exp"
dp <- list(rate = .022) # based on empirical tests
de <- TRUE

gg <- ggplot(data = airquality, mapping = aes(sample = Ozone)) +
	stat_pp_band(distribution = di, detrend = de, dparams = dp) +
	stat_pp_line(detrend = de) +
	stat_pp_point(distribution = di, detrend = de, dparams = dp) +
	labs(x = "Probability Points", y = "Cumulative Probability") +
	scale_y_continuous(limits = c(-.5, .5))
gg
```

Based on empirical tests, the chosen rate parameter is the one that best locates
de P-P points inside the confidence bands. Even though, that group of points at 
the lower tail outside the confidence bands indicate that we might need to
rethink this distribution and its parameters.

## Shiny App

Next, we present an interactive Shiny app in which you'll be able to explore,
visualize, and test even further this package functions and its parameters.

TBD

## References

* [Thode, H. (2002), Testing for Normality. CRC Press, 1st Ed.](https://www.crcpress.com/Testing-For-Normality/Thode/p/book/9780824796136)
* [Aldor-Noiman, S. et al. (2013). The Power to See: A New Graphical Test of
Normality. The American
Statistician. 67:4.](http://www.tandfonline.com/doi/abs/10.1080/00031305.2013.847865)
